{% extends "base.html" %}

{% block title %}Use Donation - Pharmacy Thabet{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">
        <i data-lucide="gift" class="icon-info"></i>
        Use Donation
    </h1>
</div>

<div class="card" style="max-width: 600px; margin-bottom: 1.5rem;">
    <div class="card-header">
        <h2 class="card-title">Donation Details</h2>
    </div>
    <div style="padding: 1rem;">
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
            <div>
                <div style="font-size: 0.875rem; color: #64748b; margin-bottom: 0.25rem;">Donation Amount</div>
                <div style="font-size: 1.25rem; font-weight: 700; color: #1e293b;">${{ "%.2f"|format(donation.amount) }}</div>
            </div>
            <div>
                <div style="font-size: 0.875rem; color: #64748b; margin-bottom: 0.25rem;">Available</div>
                <div style="font-size: 1.25rem; font-weight: 700; color: #22c55e;">${{ "%.2f"|format(donation.amount_remaining) }}</div>
            </div>
        </div>
        {% if donation.donor_name %}
        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
            <div style="font-size: 0.875rem; color: #64748b; margin-bottom: 0.25rem;">Donor</div>
            <div style="font-weight: 600;">{{ donation.donor_name }}</div>
        </div>
        {% endif %}
        {% if donation.notes %}
        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
            <div style="font-size: 0.875rem; color: #64748b; margin-bottom: 0.25rem;">Notes</div>
            <div style="color: #475569;">{{ donation.notes }}</div>
        </div>
        {% endif %}
    </div>
</div>

<div class="card" style="max-width: 600px;">
    <div class="card-header">
        <h2 class="card-title">Apply to Customer</h2>
    </div>
    <form method="POST">
        <div class="form-group">
            <label class="form-label">Customer *</label>
            <div style="position: relative;">
                <input type="text" 
                       id="customer_search_input" 
                       class="form-control" 
                       placeholder="Search customer by name or phone..."
                       autocomplete="off">
                <select name="customer_id" 
                        id="customer_select" 
                        class="form-control" 
                        required 
                        style="display: none;">
                    <option value="">-- Select a customer --</option>
                    {% for customer in customers %}
                    {% if customer.debt > 0 %}
                    <option value="{{ customer.id }}" 
                            data-name="{{ customer.name|lower }}" 
                            data-phone="{{ customer.phone|lower if customer.phone else '' }}"
                            data-debt="{{ "%.2f"|format(customer.debt) }}">
                        {{ customer.name }} - Owes ${{ "%.2f"|format(customer.debt) }}
                    </option>
                    {% endif %}
                    {% endfor %}
                </select>
                <div id="customer_results" style="display: none; position: absolute; top: 100%; left: 0; right: 0; width: 100%; background: white; border: 1px solid #e2e8f0; border-radius: 4px; max-height: 200px; overflow-y: auto; z-index: 10000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 2px; pointer-events: auto;"></div>
            </div>
            <small style="color: #64748b; font-size: 0.875rem; margin-top: 0.25rem; display: block;">
                Only customers with outstanding debt are shown
            </small>
        </div>

        <div class="form-group">
            <label class="form-label">Amount to Use *</label>
            <input type="number" name="amount" class="form-control" required step="0.01" min="0.01" max="{{ donation.amount_remaining }}" placeholder="Enter amount" value="{{ donation.amount_remaining }}">
            <small style="color: #64748b; font-size: 0.875rem; margin-top: 0.25rem; display: block;">
                Maximum available: ${{ "%.2f"|format(donation.amount_remaining) }}
            </small>
        </div>

        <div class="form-group">
            <label class="form-label">Notes (optional)</label>
            <textarea name="notes" class="form-control" rows="3" placeholder="Any notes about this usage..."></textarea>
        </div>

        <div class="btn-group">
            <button type="submit" class="btn btn-success">
                <i data-lucide="check"></i>
                Apply Donation
            </button>
            <a href="{{ url_for('donations') }}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<div class="card" style="max-width: 600px; margin-top: 1rem; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 1px solid #86efac;">
    <p style="color: #166534; font-size: 0.9rem; display: flex; align-items: start; gap: 0.5rem;">
        <i data-lucide="info" style="width: 18px; height: 18px; margin-top: 2px; flex-shrink: 0;"></i>
        <span><strong>Note:</strong> When you apply this donation, it will be recorded as a payment for the selected customer. The donation amount will be deducted from their debt balance.</span>
    </p>
</div>
{% endblock %}

{% block scripts %}
<script>
    lucide.createIcons();
    
    // Searchable customer dropdown
    const customerSearchInput = document.getElementById('customer_search_input');
    const customerSelect = document.getElementById('customer_select');
    const customerResults = document.getElementById('customer_results');
    const allCustomers = Array.from(customerSelect.options).slice(1); // Skip first empty option
    
    let selectedCustomerId = null;
    
    // Show search input, hide select
    customerSelect.style.display = 'none';
    customerSearchInput.style.display = 'block';
    
    // Filter customers as user types
    customerSearchInput.addEventListener('input', function() {
        const query = this.value.trim().toLowerCase();
        selectedCustomerId = null;
        
        if (query.length === 0) {
            customerResults.style.display = 'none';
            customerSelect.value = '';
            return;
        }
        
        // Filter customers
        const matches = allCustomers.filter(option => {
            const name = option.dataset.name || '';
            const phone = option.dataset.phone || '';
            return name.includes(query) || phone.includes(query);
        });
        
        // Display results
        if (matches.length === 0) {
            customerResults.innerHTML = '<div style="padding: 0.75rem; color: #64748b; text-align: center;">No customers found</div>';
            customerResults.style.display = 'block';
        } else {
            customerResults.innerHTML = matches.map(option => {
                const customerName = option.textContent.split(' - ')[0];
                const debtAmount = option.dataset.debt || '0.00';
                return `<div class="customer-option" 
                             data-id="${option.value}" 
                             data-text="${option.textContent}"
                             style="padding: 0.75rem; cursor: pointer; border-bottom: 1px solid #f1f5f9; user-select: none; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 500;">${customerName}</span>
                        <span style="color: #dc2626; font-weight: 600;">Owes $${parseFloat(debtAmount).toFixed(2)}</span>
                        </div>`;
            }).join('');
            customerResults.style.display = 'block';
        }
    });
    
    // Use event delegation for clicking on customer options
    customerResults.addEventListener('click', function(e) {
        const option = e.target.closest('.customer-option');
        if (option) {
            const customerId = option.dataset.id;
            const customerText = option.dataset.text;
            
            selectedCustomerId = customerId;
            customerSelect.value = customerId;
            customerSearchInput.value = customerText.split(' - ')[0]; // Show just the name
            customerResults.style.display = 'none';
        }
    });
    
    // Add hover effects using CSS
    customerResults.addEventListener('mouseover', function(e) {
        const option = e.target.closest('.customer-option');
        if (option) {
            option.style.backgroundColor = '#f8fafc';
        }
    });
    
    customerResults.addEventListener('mouseout', function(e) {
        const option = e.target.closest('.customer-option');
        if (option) {
            option.style.backgroundColor = 'white';
        }
    });
    
    // Hide results when clicking outside
    document.addEventListener('click', function(e) {
        if (!customerSearchInput.contains(e.target) && !customerResults.contains(e.target)) {
            customerResults.style.display = 'none';
        }
    });
    
    // Ensure customer is selected before form submit
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        if (!selectedCustomerId) {
            e.preventDefault();
            alert('Please select a customer from the search results');
            customerSearchInput.focus();
            return false;
        }
    });
</script>
{% endblock %}





