{% extends "base.html" %}

{% block title %}Reports - Pharmacy Thabet{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">
        <i data-lucide="file-text" class="icon-info"></i>
        Reports
    </h1>
</div>

<!-- Filter -->
<div class="card card-info">
    <div class="card-header">
        <h2 class="card-title">
            <i data-lucide="filter"></i>
            Filter
        </h2>
    </div>
    <form method="GET" action="{{ url_for('reports') }}">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
            <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label">From</label>
                <input type="date" name="start_date" class="form-control" value="{{ start_date }}">
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label">To</label>
                <input type="date" name="end_date" class="form-control" value="{{ end_date }}">
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label">Customer</label>
                <select name="customer_id" class="form-control">
                    <option value="">All Customers</option>
                    {% for c in customers %}
                    <option value="{{ c.id }}" {% if selected_customer_id == c.id|string %}selected{% endif %}>{{ c.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="btn-group">
            <button type="submit" class="btn btn-primary">
                <i data-lucide="search"></i>
                Search
            </button>
            <a href="{{ url_for('export_pdf', start_date=start_date, end_date=end_date, customer_id=selected_customer_id) }}" class="btn btn-secondary">
                <i data-lucide="download"></i>
                Download PDF
            </a>
        </div>
    </form>
</div>

<!-- Results -->
<div class="card card-info">
    <div class="card-header">
        <h2 class="card-title">
            <i data-lucide="list"></i>
            Results
        </h2>
        <span class="badge badge-info">
            Total Debt: ${{ "%.2f"|format(total_debt) }}
        </span>
    </div>

    {% if transactions %}
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Customer</th>
                    <th>Type</th>
                    <th style="text-align: right;">Amount</th>
                    <th>Notes</th>
                </tr>
            </thead>
            <tbody>
                {% for t in transactions %}
                <tr>
                    <td>{{ t.created_at[:10] if t.created_at else t.date[:10] if t.date else '-' }}</td>
                    <td>
                        <a href="{{ url_for('customer_detail', customer_id=t.customer_id) }}">
                            {{ t.customer_name }}
                        </a>
                    </td>
                    <td>
                        {% if t.entry_type == 'NEW_DEBT' %}
                        <span class="badge badge-debt">Debt</span>
                        {% elif t.entry_type == 'PAYMENT' %}
                        <span class="badge badge-payment">Payment</span>
                        {% else %}
                        <span class="badge badge-info">{{ t.entry_type }}</span>
                        {% endif %}
                    </td>
                    <td style="text-align: right;">
                        {% if t.entry_type == 'NEW_DEBT' %}
                        <span style="color: #dc2626; font-weight: 600;">+${{ "%.2f"|format(t.amount or t.total or 0) }}</span>
                        {% else %}
                        <span style="color: #16a34a; font-weight: 600;">-${{ "%.2f"|format(t.amount|abs or 0) }}</span>
                        {% endif %}
                    </td>
                    <td>{{ t.description or t.notes or '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <i data-lucide="inbox" style="width: 48px; height: 48px; opacity: 0.3;"></i>
        <p>No results for this date range.</p>
    </div>
    {% endif %}
</div>
{% endblock %}
